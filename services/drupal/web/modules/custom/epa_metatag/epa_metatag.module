<?php

/**
 * @file
 * Contains epa_metatag.module.
 */

use Drupal\Core\Field\FieldDefinitionInterface;
use Drupal\Core\Field\FieldItemListInterface;
use Drupal\Core\Session\AccountInterface;
use Drupal\Core\Access\AccessResult;

/**
 * Implements hook_page_attachments_alter()
 *
 * @param array $attachments
 */
function epa_metatag_page_attachments_alter(array &$attachments) {
  // Remove tag that shows the site was generated by Drupal.
  foreach ($attachments['#attached']['html_head'] as $key => $attachment) {
    if ($attachment[1] == 'system_meta_generator') {
      unset($attachments['#attached']['html_head'][$key]);
    }
  }
}

/**
 * Implements hook_entity_field_access().
 */
function epa_metatag_entity_field_access($operation, FieldDefinitionInterface $field_definition, AccountInterface $account, FieldItemListInterface $items = NULL) {
  $context = ($operation == 'view') ? 'display' : 'edit';
  if (!$field_definition->isDisplayConfigurable($context) || empty($items)) {
    return AccessResult::neutral();
  }
  if ($field_definition->getName() == 'field_meta_tags') {
    $allowed_roles = ['administrator', 'system_webmaster', 'system_editor'];
    $matches = array_intersect($account->getRoles(), $allowed_roles);
    if (empty($matches)) {
      return AccessResult::forbidden();
    }
  }
  return AccessResult::neutral();
}
